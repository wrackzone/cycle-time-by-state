<!DOCTYPE html>
<html>
<head>
    <title>cycletimebystate</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>
    <script type="text/javascript" src="https://storage.googleapis.com/versions.lumenize.com/v0.7.2/Lumenize-min.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.3.1/moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://googledrive.com/host/0B3qw8lEQxbDXeWw2aFRWbWcydHc"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){console.log("launch"),app=this,this.startDate=moment().subtract("month",app.getSetting("months")).toISOString(),""===app.getSetting("type")&&""===app.getSetting("stateField")&&""===app.getSetting("finalValue")?this.createUI():(app.type=app.getSetting("type"),app.kanbanField=app.getSetting("stateField"),app.finalValue=app.getSetting("finalValue"));var panel=Ext.create("Ext.container.Container",{itemId:"panel",title:"Hello",width:800,height:600,html:"<p></p>"});this.add(panel);var p=this.down("#panel");app.jqPanel="#"+p.id,(""!==app.getSetting("stateField")||""!==app.getSetting("finalValue"))&&app.run()},config:{defaultSettings:{type:"",stateField:"",finalValue:"",timeInHours:!1,months:6}},getSettingsFields:function(){var values=[{name:"type",xtype:"rallytextfield",label:"Comma delimited list of types eg. Story,Defect or PortfolioItem/Feature"},{name:"stateField",xtype:"rallytextfield",label:"Field name cycle time calculation is based on eg. State"},{name:"finalValue",xtype:"rallytextfield",label:"Filter items that have moved into this state eg. Closed or Accepted"},{name:"timeInHours",xtype:"rallycheckboxfield",label:"Show cycle time values in hours (instead of days)"},{name:"months",xtype:"rallytextfield",label:"Number of months to consider"}];return values},run:function(){app.mask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),app.mask.show(),async.waterfall([app.getCompletedItems,app.getSnapshotsForCompletedItems,app.getProjectNamesForCompletedItems,app.prepareSnapshots,app.pivotData],function(err,results){app.mask.hide()})},createUI:function(){var createButton=function(){app.goButton&&app.goButton.destroy(),app.goButton=Ext.create("Rally.ui.Button",{margin:5,height:20,text:"Go",handler:function(){console.log("fieldCombo:",app.fieldCombo.getValue()),console.log("valueCombo:",app.valueCombo.getValue()),app.kanbanField=app.fieldCombo.getValue(),app.finalValue=app.valueCombo.getValue(),app.run()}}),app.boxcontainer.add(app.goButton)},createValueCombo=function(valuefield){return app.valueCombo&&app.valueCombo.destroy(),app.valueCombo=Ext.create("Rally.ui.combobox.FieldValueComboBox",{padding:5,stateful:!0,stateId:"Rally.ui.combobox.FieldValueComboBox",model:"UserStory",field:valuefield,listeners:{ready:function(t){console.log("value ready",t.getValue()),""!==t.getValue()&&createButton()},select:function(a,selected,c){console.log("selected",selected[0].get("value")),createButton()}}}),app.valueCombo};app.fieldCombo=Ext.create("Rally.ui.combobox.FieldComboBox",{padding:5,stateful:!0,stateId:"Rally.ui.combobox.FieldComboBox",model:"UserStory",listeners:{ready:function(t,e){createValueCombo(t.getValue()),app.boxcontainer.add(app.valueCombo)},select:function(a,selected,c){console.log("selected",selected),createValueCombo(selected[0].get("value")),app.goButton&&app.goButton.destroy(),app.boxcontainer.add(app.valueCombo)}}}),app.boxcontainer=Ext.create("Ext.container.Container",{itemId:"container",layout:{type:"hbox"},width:400,border:1,style:{borderColor:"#000000",borderStyle:"solid",borderWidth:"1px"}}),app.boxcontainer.add(app.fieldCombo),this.add(app.boxcontainer)},getTypes:function(){var types=_.map(app.type.split(","),function(t){return"STORY"!==t.toUpperCase()?t:"HierarchicalRequirement"});return console.log("types:",types),types},getCompletedItems:function(callback){var that=this,fetch=["FormattedID","ObjectID","_TypeHierarchy","_PreviousValues","PlanEstimate","Project",app.kanbanField],hydrate=["_TypeHierarchy",app.kanbanField],find={_TypeHierarchy:{$in:app.getTypes()},_ProjectHierarchy:{$in:[app.getContext().getProject().ObjectID]}};-1!==_.findIndex(app.getTypes(),function(t){return"HIERARCHICALREQUIREMENT"===t.toUpperCase()})&&(find.Children={$exists:!1}),find[app.kanbanField]=app.finalValue,find["_PreviousValues."+app.kanbanField]={$ne:null},find._ValidFrom={$gte:app.startDate};var storeConfig={find:find,autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:fetch,hydrate:hydrate,listeners:{scope:this,load:function(store,snapshots,success){console.log("success",success),console.log("completed snapshots:",snapshots.length),console.log("unique completed   :",_.uniq(_.map(snapshots,function(s){return s.get("ObjectID")})).length),callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},prepareSnapshots:function(completedItems,snapshots,callback){_.each(snapshots,function(s){var ci=_.find(completedItems,function(c){return c.get("ObjectID")===s.get("ObjectID")}),month=moment(ci.get("_ValidFrom")).format("MMM YYYY");s.set("CompletedDate",ci.get("_ValidFrom")),s.set("Month",month),s.set("Size",ci.get("PlanEstimate"))}),callback(null,completedItems,snapshots)},pivotData:function(completedItems,snapshots,callback){var addCommas=function(nStr){var rgx,x,x1,x2;for(nStr+="",x=nStr.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"",rgx=/(\d+)(\d{3})/;rgx.test(x1);)x1=x1.replace(rgx,"$1,$2");return x1+x2},numberFormat=function(sigfig,scaler){return null==sigfig&&(sigfig=3),null==scaler&&(scaler=1),function(x){return 0===x||isNaN(x)||!isFinite(x)?"":addCommas((scaler*x).toFixed(sigfig))}},cycleTime=function(){return function(x,y,z){var xx=x,yy=y,zz=z;return{recs:[],push:function(record){return this.recs.push(record),this.recs.length},value:function(value){console.log("Records for:",yy,zz);var ct=calcCyleTime(this.recs);console.log("#ids",_.pluck(ct,"FormattedID")),console.log("#cycletimes",_.pluck(ct,"ticks"));var mean=_.mean(_.pluck(ct,"ticks")),median=_.median(_.pluck(ct,"ticks")),max=_.max(_.pluck(ct,"ticks")),min=_.min(_.pluck(ct,"ticks")),cnt=_.pluck(ct,"ticks").length,stddev=_.stdDeviation(_.pluck(ct,"ticks")),cov=0!==mean?stddev/mean:0;return mean=parseFloat(Math.round(100*mean)/100).toFixed(2),median=parseFloat(Math.round(100*median)/100).toFixed(2),stddev=parseFloat(Math.round(100*stddev)/100).toFixed(2),cov=parseFloat(Math.round(100*cov)/100).toFixed(2),console.log("cnt/mean/median/max/min/stddev/cov",cnt,",",mean,",",median,",",max,",",min,",",stddev,",",cov),mean},format:numberFormat(0),label:"cycleTime"}}},calcCyleTime=function(snapshots){var that=this,granularity=app.getSetting("timeInHours")===!1?"day":"hour",tz="America/New_York",config={granularity:granularity,tz:tz,validFromField:"_ValidFrom",validToField:"_ValidTo",uniqueIDField:"FormattedID",workDayStartOn:{hour:13,minute:0},workDayEndBefore:{hour:22,minute:0}},start=moment().dayOfYear(0).toISOString(),end=moment().toISOString();tisc=new window.parent._lumenize.TimeInStateCalculator(config),tisc.addSnapshots(snapshots,start,end);var results=tisc.getResults();return console.timeEnd("cycle-time"),results},teamNameDeriver=function(record){var p=_.find(app.projects,function(f){return record.Project===f.get("ObjectID")});return p?p.get("Name"):record.Project},completedDateDeriver=function(record){return moment(record.CompletedDate).format("MMM YYYY")},data=_.map(snapshots,function(s){return s.data});$(app.jqPanel).pivotUI(data,{derivedAttributes:{Team:teamNameDeriver,MonthCompleted:completedDateDeriver},aggregators:{cycleTime:cycleTime},rows:[app.kanbanField],cols:["Team"],hiddenAttributes:["PlanEstimate","ObjectID","_TypeHierarchy","_UnformattedID","_ValidFrom","_ValidTo","Project","CompletedDate"]}),callback(null,completedItems,snapshots)},readSnapshots:function(config,callback){console.log("reading page of snapshots...");var storeConfig={find:config.find,autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:config.fetch,hydrate:config.hydrate,listeners:{scope:this,load:function(store,snapshots,success){callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},getProjectNamesForCompletedItems:function(completedItems,snapshots,callback){var projectOids=_.uniq(_.pluck(snapshots,function(c){return c.get("Project")}));console.log("Distinct Project IDs:",projectOids);var configs=_.map(projectOids,function(p){return{model:"Project",fetch:["Name","ObjectID","FormattedID"],filters:[{property:"ObjectID",value:p}]}});async.map(configs,app.wsapiQuery,function(err,results){app.projects=_.flatten(results);var filteredSnapshots=_.filter(snapshots,function(s){var p=_.find(app.projects,function(p){return s.get("Project")===p.get("ObjectID")});return!_.isUndefined(p)&&!_.isNull(p)});console.log("projects:",app.projects),callback(null,completedItems,filteredSnapshots)})},getSnapshotsForCompletedItems:function(completedItems,callback){var that=this,completedOids=_.uniq(_.pluck(completedItems,function(c){return c.get("ObjectID")}));console.log("oids",completedOids.length);var oidsArrays=[],i,j,chunk=50;for(i=0,j=completedOids.length;j>i;i+=chunk)oidsArrays.push(completedOids.slice(i,i+chunk));console.log("oidsArrays",oidsArrays);var configs=_.map(oidsArrays,function(oArray){return{fetch:["FormattedID","_UnformattedID","ObjectID","_TypeHierarchy","PlanEstimate","ScheduleState",app.kanbanField],hydrate:["_TypeHierarchy","ScheduleState",app.kanbanField],find:{_TypeHierarchy:{$in:app.getTypes()},_ProjectHierarchy:{$in:[app.getContext().getProject().ObjectID]},ObjectID:{$in:oArray}}}});async.mapSeries(configs,app.readSnapshots,function(err,results){var snapshots=[];_.each(results,function(r){snapshots=snapshots.concat(r)}),console.log("total snapshots",snapshots.length),callback(null,completedItems,snapshots)})},summarizeResults:function(stateResults,callback){_.each(stateResults,function(result){var resultTicks=_.pluck(result.results,function(r){return r.ticks});result.min=_.min(resultTicks),result.max=_.max(resultTicks),result.avg=_.reduce(resultTicks,function(memo,num){return memo+num},0)/resultTicks.length,result.median=_.median(_.sortBy(resultTicks),function(r){return r}),result.mean=_.mean(resultTicks,function(r){return r}),result.ticks=_.sortBy(resultTicks)}),callback(null,stateResults)},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}});
                (function(){var math=this.math={};math.mean=math.ave=math.average=function(obj,key){return math.sum(obj,key)/_.size(obj)},math.median=function(arr){arr=arr.slice(0);var middle=(arr.length+1)/2,sorted=math.sort(arr);return sorted.length%2?sorted[middle-1]:(sorted[middle-1.5]+sorted[middle-.5])/2},math.pow=math.power=function(x,n){return _.isNumber(x)?Math.pow(x,n):_.isArray(x)?_.map(x,function(i){return _.pow(i,n)}):void 0},math.round=function(number,decimals){return Math.round(number*Math.pow(10,decimals))/Math.pow(10,decimals)},math.scale=function(arr,max){max=max||1;var max0=_.max(arr);return _.map(arr,function(i){return i*(max/max0)})},math.slope=function(x,y){return(y[1]-x[1])/(y[0]-x[0])},math.sort=function(arr){return _.sortBy(arr,_.identity)},math.stdDeviation=math.sigma=function(arr){return Math.sqrt(_.variance(arr))},math.sum=function(obj,key){var arr;_.isArray(obj)&&"number"==typeof obj[0]?arr=obj:(key=key||"value",arr=_.pluck(obj,key));var val=0,i;for(i=0;arr.length>i;i++)val+=arr[i]-0;return val},math.transpose=function(arr){var trans=[];return _.each(arr,function(row,y){_.each(row,function(col,x){trans[x]||(trans[x]=[]),trans[x][y]=col})}),trans},math.variance=function(arr){var mean=_.mean(arr),variance=function(x){return _.pow(x-mean,2)};return _(arr).map(variance).mean().value()},math.zscore=function(obj,key){var arr;_.isArray(obj)&&"number"==typeof obj[0]?arr=obj:(key=key||"value",arr=_.pluck(obj,key));var mean=_.mean(arr),sigma=_.stdDeviation(arr),zscore=function(d){return(d-mean)/sigma};return _.map(arr,zscore)},math.movingAvg=math.movingAverage=function(arr,size){var win,i,newarr=[];for(i=size-1;arr.length>=i;i++)win=arr.slice(i-size,i),win.length===size&&newarr.push(_.mean(win));return newarr},_.mixin(math)})();

            Rally.launchApp('CustomApp', {
                name:"cycletimebystate",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
    <style type="text/css">
        table.pvtTable{font-family:arial;font-size:8pt;text-align:left;border-collapse:collapse}table.pvtTable tr th,table.pvtTable tr th{background-color:#e6EEEE;border:1px solid #CDCDCD;font-size:8pt;padding:5px}table.pvtTable .pvtColLabel{text-align:center}table.pvtTable .pvtTotalLabel{text-align:right}table.pvtTable tr td{color:#3D3D3D;padding:5px;background-color:#FFF;border:1px solid #CDCDCD;vertical-align:top;text-align:right}.pvtTotal,.pvtGrandTotal{font-weight:bold}.pvtAxisContainer{border:1px solid gray;background:#EEE;padding:5px;min-width:20px;min-height:20px}.pvtAxisContainer li{padding:8px 6px;list-style-type:none;cursor:move}.pvtAxisContainer li.placeholder{-webkit-border-radius:5px;padding:3px 15px;-moz-border-radius:5px;border-radius:5px;border:1px dashed #aaa}.pvtAxisContainer li nobr{background:#F3F3F3;border:1px solid #DEDEDE;padding:2px 5px;-webkit-border-radius:5px;-moz-border-radius:5px;border-radius:5px}.pvtTriangle{cursor:pointer;color:grey}.pvtHorizList li{display:inline}.pvtFilteredAttribute{font-style:italic}
    </style>
</head>
<body>
</body>
</html>
