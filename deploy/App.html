<!DOCTYPE html>
<html>
<head>
    <title>cycletimebystate</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.3.1/moment.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){console.log("launch"),app=this,this.startDate=moment().subtract("month",app.getSetting("months")).toISOString(),""===app.getSetting("type")&&""===app.getSetting("stateField")&&""===app.getSetting("finalValue")?this.createUI():(app.type=app.getSetting("type"),app.kanbanField=app.getSetting("stateField"),app.finalValue=app.getSetting("finalValue"));var panel=Ext.create("Ext.container.Container",{itemId:"panel",title:"Hello",width:800,height:600,html:"<p></p>"});this.add(panel);var p=this.down("#panel");app.jqPanel="#"+p.id,(""!==app.getSetting("stateField")||""!==app.getSetting("finalValue"))&&app.run()},config:{defaultSettings:{type:"",stateField:"",finalValue:"",timeInHours:!1,months:6}},getSettingsFields:function(){var values=[{name:"type",xtype:"rallytextfield",label:"Comma delimited list of types eg. Story,Defect or PortfolioItem/Feature"},{name:"stateField",xtype:"rallytextfield",label:"Field name cycle time calculation is based on eg. State"},{name:"finalValue",xtype:"rallytextfield",label:"Filter items that have moved into this state eg. Closed or Accepted"},{name:"timeInHours",xtype:"rallycheckboxfield",label:"Show cycle time values in hours (instead of days)"},{name:"months",xtype:"rallytextfield",label:"Number of months to consider"}];return values},run:function(){app.mask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),app.mask.show(),async.waterfall([app.getCompletedItems,app.getSnapshotsForCompletedItems,app.getProjectNamesForCompletedItems,app.prepareSnapshots,app.pivotData],function(err,results){app.mask.hide()})},createUI:function(){var createButton=function(){app.goButton&&app.goButton.destroy(),app.goButton=Ext.create("Rally.ui.Button",{margin:5,height:20,text:"Go",handler:function(){console.log("fieldCombo:",app.fieldCombo.getValue()),console.log("valueCombo:",app.valueCombo.getValue()),app.kanbanField=app.fieldCombo.getValue(),app.finalValue=app.valueCombo.getValue(),app.run()}}),app.boxcontainer.add(app.goButton)},createValueCombo=function(valuefield){return app.valueCombo&&app.valueCombo.destroy(),app.valueCombo=Ext.create("Rally.ui.combobox.FieldValueComboBox",{padding:5,stateful:!0,stateId:"Rally.ui.combobox.FieldValueComboBox",model:"UserStory",field:valuefield,listeners:{ready:function(t){console.log("value ready",t.getValue()),""!==t.getValue()&&createButton()},select:function(a,selected,c){console.log("selected",selected[0].get("value")),createButton()}}}),app.valueCombo};app.fieldCombo=Ext.create("Rally.ui.combobox.FieldComboBox",{padding:5,stateful:!0,stateId:"Rally.ui.combobox.FieldComboBox",model:"UserStory",listeners:{ready:function(t,e){createValueCombo(t.getValue()),app.boxcontainer.add(app.valueCombo)},select:function(a,selected,c){console.log("selected",selected),createValueCombo(selected[0].get("value")),app.goButton&&app.goButton.destroy(),app.boxcontainer.add(app.valueCombo)}}}),app.boxcontainer=Ext.create("Ext.container.Container",{itemId:"container",layout:{type:"hbox"},width:400,border:1,style:{borderColor:"#000000",borderStyle:"solid",borderWidth:"1px"}}),app.boxcontainer.add(app.fieldCombo),this.add(app.boxcontainer)},getTypes:function(){var types=_.map(app.type.split(","),function(t){return"STORY"!==t.toUpperCase()?t:"HierarchicalRequirement"});return console.log("types:",types),types},getCompletedItems:function(callback){var that=this,fetch=["FormattedID","ObjectID","_TypeHierarchy","_PreviousValues","PlanEstimate","Project",app.kanbanField],hydrate=["_TypeHierarchy",app.kanbanField],find={_TypeHierarchy:{$in:app.getTypes()},_ProjectHierarchy:{$in:[app.getContext().getProject().ObjectID]}};-1!==_.findIndex(app.getTypes(),function(t){return"HIERARCHICALREQUIREMENT"===t.toUpperCase()})&&(find.Children={$exists:!1}),find[app.kanbanField]=app.finalValue,find["_PreviousValues."+app.kanbanField]={$ne:null},find._ValidFrom={$gte:app.startDate};var storeConfig={find:find,autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:fetch,hydrate:hydrate,listeners:{scope:this,load:function(store,snapshots,success){console.log("success",success),console.log("completed snapshots:",snapshots.length),console.log("unique completed   :",_.uniq(_.map(snapshots,function(s){return s.get("ObjectID")})).length),callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},prepareSnapshots:function(completedItems,snapshots,callback){_.each(snapshots,function(s){var ci=_.find(completedItems,function(c){return c.get("ObjectID")===s.get("ObjectID")}),month=moment(ci.get("_ValidFrom")).format("MMM YYYY");s.set("CompletedDate",ci.get("_ValidFrom")),s.set("Month",month),s.set("Size",ci.get("PlanEstimate"))}),callback(null,completedItems,snapshots)},pivotData:function(completedItems,snapshots,callback){var addCommas=function(nStr){var rgx,x,x1,x2;for(nStr+="",x=nStr.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"",rgx=/(\d+)(\d{3})/;rgx.test(x1);)x1=x1.replace(rgx,"$1,$2");return x1+x2},numberFormat=function(sigfig,scaler){return null==sigfig&&(sigfig=3),null==scaler&&(scaler=1),function(x){return 0===x||isNaN(x)||!isFinite(x)?"":addCommas((scaler*x).toFixed(sigfig))}},cycleTime=function(){return function(x,y,z){var xx=x,yy=y,zz=z;return{recs:[],push:function(record){return this.recs.push(record),this.recs.length},value:function(value){console.log("Records for:",yy,zz);var ct=calcCyleTime(this.recs);console.log("#ids",_.pluck(ct,"FormattedID")),console.log("#cycletimes",_.pluck(ct,"ticks"));var mean=_.mean(_.pluck(ct,"ticks")),median=_.median(_.pluck(ct,"ticks")),max=_.max(_.pluck(ct,"ticks")),min=_.min(_.pluck(ct,"ticks")),cnt=_.pluck(ct,"ticks").length,stddev=_.stdDeviation(_.pluck(ct,"ticks")),cov=0!==mean?stddev/mean:0;return mean=parseFloat(Math.round(100*mean)/100).toFixed(2),median=parseFloat(Math.round(100*median)/100).toFixed(2),stddev=parseFloat(Math.round(100*stddev)/100).toFixed(2),cov=parseFloat(Math.round(100*cov)/100).toFixed(2),console.log("cnt/mean/median/max/min/stddev/cov",cnt,",",mean,",",median,",",max,",",min,",",stddev,",",cov),mean},format:numberFormat(0),label:"cycleTime"}}},calcCyleTime=function(snapshots){var that=this,granularity=app.getSetting("timeInHours")===!1?"day":"hour",tz="America/New_York",config={granularity:granularity,tz:tz,validFromField:"_ValidFrom",validToField:"_ValidTo",uniqueIDField:"FormattedID",workDayStartOn:{hour:13,minute:0},workDayEndBefore:{hour:22,minute:0}},start=moment().subtract(1,"years").toISOString(),end=moment().toISOString(),tisc=null;tisc=_.isUndefined(window.parent._lumenize)?new window._lumenize.TimeInStateCalculator(config):new window.parent._lumenize.TimeInStateCalculator(config),tisc.addSnapshots(snapshots,start,end);var results=tisc.getResults();return console.timeEnd("cycle-time"),results},teamNameDeriver=function(record){var p=_.find(app.projects,function(f){return record.Project===f.get("ObjectID")});return p?p.get("Name"):record.Project},completedDateDeriver=function(record){return moment(record.CompletedDate).format("MMM YYYY")},data=_.map(snapshots,function(s){return s.data});$(app.jqPanel).pivotUI(data,{derivedAttributes:{Team:teamNameDeriver,MonthCompleted:completedDateDeriver},aggregators:{cycleTime:cycleTime},rows:[app.kanbanField],cols:["Team"],hiddenAttributes:["PlanEstimate","ObjectID","_TypeHierarchy","_UnformattedID","_ValidFrom","_ValidTo","Project","CompletedDate"]}),callback(null,completedItems,snapshots)},readSnapshots:function(config,callback){console.log("reading page of snapshots...");var storeConfig={find:config.find,autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:config.fetch,hydrate:config.hydrate,listeners:{scope:this,load:function(store,snapshots,success){callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},getProjectNamesForCompletedItems:function(completedItems,snapshots,callback){var projectOids=_.uniq(_.pluck(snapshots,function(c){return c.get("Project")}));console.log("Distinct Project IDs:",projectOids);var configs=_.map(projectOids,function(p){return{model:"Project",fetch:["Name","ObjectID","FormattedID"],filters:[{property:"ObjectID",value:p}]}});async.map(configs,app.wsapiQuery,function(err,results){app.projects=_.flatten(results);var filteredSnapshots=_.filter(snapshots,function(s){var p=_.find(app.projects,function(p){return s.get("Project")===p.get("ObjectID")});return!_.isUndefined(p)&&!_.isNull(p)});console.log("projects:",app.projects),callback(null,completedItems,filteredSnapshots)})},getSnapshotsForCompletedItems:function(completedItems,callback){var that=this,completedOids=_.uniq(_.pluck(completedItems,function(c){return c.get("ObjectID")}));console.log("oids",completedOids.length);var oidsArrays=[],i,j,chunk=50;for(i=0,j=completedOids.length;j>i;i+=chunk)oidsArrays.push(completedOids.slice(i,i+chunk));console.log("oidsArrays",oidsArrays);var configs=_.map(oidsArrays,function(oArray){return{fetch:["FormattedID","_UnformattedID","ObjectID","_TypeHierarchy","PlanEstimate","ScheduleState",app.kanbanField],hydrate:["_TypeHierarchy","ScheduleState",app.kanbanField],find:{_TypeHierarchy:{$in:app.getTypes()},_ProjectHierarchy:{$in:[app.getContext().getProject().ObjectID]},ObjectID:{$in:oArray}}}});async.mapSeries(configs,app.readSnapshots,function(err,results){var snapshots=[];_.each(results,function(r){snapshots=snapshots.concat(r)}),console.log("total snapshots",snapshots.length),callback(null,completedItems,snapshots)})},summarizeResults:function(stateResults,callback){_.each(stateResults,function(result){var resultTicks=_.pluck(result.results,function(r){return r.ticks});result.min=_.min(resultTicks),result.max=_.max(resultTicks),result.avg=_.reduce(resultTicks,function(memo,num){return memo+num},0)/resultTicks.length,result.median=_.median(_.sortBy(resultTicks),function(r){return r}),result.mean=_.mean(resultTicks,function(r){return r}),result.ticks=_.sortBy(resultTicks)}),callback(null,stateResults)},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}});
                (function(){var math=this.math={};math.mean=math.ave=math.average=function(obj,key){return math.sum(obj,key)/_.size(obj)},math.median=function(arr){arr=arr.slice(0);var middle=(arr.length+1)/2,sorted=math.sort(arr);return sorted.length%2?sorted[middle-1]:(sorted[middle-1.5]+sorted[middle-.5])/2},math.pow=math.power=function(x,n){return _.isNumber(x)?Math.pow(x,n):_.isArray(x)?_.map(x,function(i){return _.pow(i,n)}):void 0},math.round=function(number,decimals){return Math.round(number*Math.pow(10,decimals))/Math.pow(10,decimals)},math.scale=function(arr,max){max=max||1;var max0=_.max(arr);return _.map(arr,function(i){return i*(max/max0)})},math.slope=function(x,y){return(y[1]-x[1])/(y[0]-x[0])},math.sort=function(arr){return _.sortBy(arr,_.identity)},math.stdDeviation=math.sigma=function(arr){return Math.sqrt(_.variance(arr))},math.sum=function(obj,key){var arr;_.isArray(obj)&&"number"==typeof obj[0]?arr=obj:(key=key||"value",arr=_.pluck(obj,key));var val=0,i;for(i=0;arr.length>i;i++)val+=arr[i]-0;return val},math.transpose=function(arr){var trans=[];return _.each(arr,function(row,y){_.each(row,function(col,x){trans[x]||(trans[x]=[]),trans[x][y]=col})}),trans},math.variance=function(arr){var mean=_.mean(arr),variance=function(x){return _.pow(x-mean,2)};return _(arr).map(variance).mean().value()},math.zscore=function(obj,key){var arr;_.isArray(obj)&&"number"==typeof obj[0]?arr=obj:(key=key||"value",arr=_.pluck(obj,key));var mean=_.mean(arr),sigma=_.stdDeviation(arr),zscore=function(d){return(d-mean)/sigma};return _.map(arr,zscore)},math.movingAvg=math.movingAverage=function(arr,size){var win,i,newarr=[];for(i=size-1;arr.length>=i;i++)win=arr.slice(i-size,i),win.length===size&&newarr.push(_.mean(win));return newarr},_.mixin(math)})();
                (function(){var $,PivotData,addSeparators,aggregatorTemplates,aggregators,convertToArray,dayNames,deriveAttributes,derivers,forEachRecord,getPivotData,mthNames,naturalSort,numberFormat,pivotTableRenderer,renderers,spanSize,zeroPad,__slice=[].slice,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1},_this=this,__hasProp={}.hasOwnProperty,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};$=jQuery,addSeparators=function(nStr,thousandsSep,decimalSep){var rgx,x,x1,x2;for(nStr+="",x=nStr.split("."),x1=x[0],x2=x.length>1?decimalSep+x[1]:"",rgx=/(\d+)(\d{3})/;rgx.test(x1);)x1=x1.replace(rgx,"$1"+thousandsSep+"$2");return x1+x2},numberFormat=function(sigfig,scaler,thousandsSep,decimalSep){return null==sigfig&&(sigfig=3),null==scaler&&(scaler=1),null==thousandsSep&&(thousandsSep=","),null==decimalSep&&(decimalSep="."),function(x){return 0===x||isNaN(x)||!isFinite(x)?"":addSeparators((scaler*x).toFixed(sigfig),thousandsSep,decimalSep)}},aggregatorTemplates={sum:function(sigfig,scaler){return null==sigfig&&(sigfig=3),null==scaler&&(scaler=1),function(_arg){var attr;return attr=_arg[0],function(){return{sum:0,push:function(record){return isNaN(parseFloat(record[attr]))?void 0:this.sum+=parseFloat(record[attr])},value:function(){return this.sum},format:numberFormat(sigfig,scaler),label:"Sum of "+attr}}}},average:function(sigfig,scaler){return null==sigfig&&(sigfig=3),null==scaler&&(scaler=1),function(_arg){var attr;return attr=_arg[0],function(){return{sum:0,len:0,push:function(record){return isNaN(parseFloat(record[attr]))?void 0:(this.sum+=parseFloat(record[attr]),this.len++)},value:function(){return this.sum/this.len},format:numberFormat(sigfig,scaler),label:"Average of "+attr}}}},sumOverSum:function(sigfig,scaler){return null==sigfig&&(sigfig=3),null==scaler&&(scaler=1),function(_arg){var denom,num;return num=_arg[0],denom=_arg[1],function(){return{sumNum:0,sumDenom:0,push:function(record){return isNaN(parseFloat(record[num]))||(this.sumNum+=parseFloat(record[num])),isNaN(parseFloat(record[denom]))?void 0:this.sumDenom+=parseFloat(record[denom])},value:function(){return this.sumNum/this.sumDenom},format:numberFormat(sigfig,scaler),label:""+num+"/"+denom}}}},sumOverSumBound80:function(sigfig,scaler,upper){return null==sigfig&&(sigfig=3),null==scaler&&(scaler=1),null==upper&&(upper=!0),function(_arg){var denom,num;return num=_arg[0],denom=_arg[1],function(){return{sumNum:0,sumDenom:0,push:function(record){return isNaN(parseFloat(record[num]))||(this.sumNum+=parseFloat(record[num])),isNaN(parseFloat(record[denom]))?void 0:this.sumDenom+=parseFloat(record[denom])},value:function(){var sign;return sign=upper?1:-1,(.821187207574908/this.sumDenom+this.sumNum/this.sumDenom+1.2815515655446004*sign*Math.sqrt(.410593603787454/(this.sumDenom*this.sumDenom)+this.sumNum*(1-this.sumNum/this.sumDenom)/(this.sumDenom*this.sumDenom)))/(1+1.642374415149816/this.sumDenom)},format:numberFormat(sigfig,scaler),label:""+(upper?"Upper":"Lower")+" Bound of "+num+"/"+denom}}}},fractionOf:function(wrapped,type){return null==type&&(type="total"),function(){var x;return x=arguments.length>=1?__slice.call(arguments,0):[],function(data,rowKey,colKey){return{selector:{total:[[],[]],row:[rowKey,[]],col:[[],colKey]}[type],inner:wrapped.apply(null,x)(data,rowKey,colKey),push:function(record){return this.inner.push(record)},format:function(v){return numberFormat(2)(100*v)+"%"},label:wrapped.apply(null,x)(data,rowKey,colKey).label+" % of "+type,value:function(){return this.inner.value()/data.getAggregator.apply(data,this.selector).inner.value()}}}}},l10nWrapper:function(wrapped,formatter,labelFn){return function(){var x;return x=arguments.length>=1?__slice.call(arguments,0):[],function(data,rowKey,colKey){return{inner:wrapped.apply(null,x)(data,rowKey,colKey),push:function(record){return this.inner.push(record)},format:formatter,label:labelFn(data),value:function(){return this.inner.value()}}}}}},aggregators={count:function(){return function(){return{count:0,push:function(){return this.count++},value:function(){return this.count},format:numberFormat(0),label:"Count"}}},countUnique:function(_arg){var attr;return attr=_arg[0],function(){return{uniq:[],push:function(record){var _ref;return _ref=record[attr],0>__indexOf.call(this.uniq,_ref)?this.uniq.push(record[attr]):void 0},value:function(){return this.uniq.length},format:numberFormat(0),label:"Count Unique "+attr}}},listUnique:function(_arg){var attr;return attr=_arg[0],function(){return{uniq:[],push:function(record){var _ref;return _ref=record[attr],0>__indexOf.call(this.uniq,_ref)?this.uniq.push(record[attr]):void 0},value:function(){return this.uniq.join(", ")},format:function(x){return x},label:"List Unique "+attr}}},intSum:aggregatorTemplates.sum(0),sum:aggregatorTemplates.sum(3),average:aggregatorTemplates.average(3),sumOverSum:aggregatorTemplates.sumOverSum(3),ub80:aggregatorTemplates.sumOverSumBound80(3,1,!0),lb80:aggregatorTemplates.sumOverSumBound80(3,1,!1)},aggregators.sumAsFractionOfTotal=aggregatorTemplates.fractionOf(aggregators.sum),aggregators.sumAsFractionOfRow=aggregatorTemplates.fractionOf(aggregators.sum,"row"),aggregators.sumAsFractionOfCol=aggregatorTemplates.fractionOf(aggregators.sum,"col"),aggregators.countAsFractionOfTotal=aggregatorTemplates.fractionOf(aggregators.count),aggregators.countAsFractionOfRow=aggregatorTemplates.fractionOf(aggregators.count,"row"),aggregators.countAsFractionOfCol=aggregatorTemplates.fractionOf(aggregators.count,"col"),renderers={Table:function(pvtData,opts){return pivotTableRenderer(pvtData,opts)},"Table Barchart":function(pvtData,opts){return pivotTableRenderer(pvtData,opts).barchart()},Heatmap:function(pvtData,opts){return pivotTableRenderer(pvtData,opts).heatmap()},"Row Heatmap":function(pvtData,opts){return pivotTableRenderer(pvtData,opts).heatmap("rowheatmap")},"Col Heatmap":function(pvtData,opts){return pivotTableRenderer(pvtData,opts).heatmap("colheatmap")}},mthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNames=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],zeroPad=function(number){return("0"+number).substr(-2,2)},derivers={bin:function(col,binWidth){return function(record){return record[col]-record[col]%binWidth}},dateFormat:function(col,formatString){return function(record){var date;return date=new Date(Date.parse(record[col])),isNaN(date)?"":formatString.replace(/%(.)/g,function(m,p){switch(p){case"y":return date.getFullYear();case"m":return zeroPad(date.getMonth()+1);case"n":return mthNames[date.getMonth()];case"d":return zeroPad(date.getDate());case"w":return dayNames[date.getDay()];case"x":return date.getDay();case"H":return zeroPad(date.getHours());case"M":return zeroPad(date.getMinutes());case"S":return zeroPad(date.getSeconds());default:return"%"+p}})}}},naturalSort=function(as,bs){var a,a1,b,b1,rd,rx,rz;if(rx=/(\d+)|(\D+)/g,rd=/\d/,rz=/^0/,"number"==typeof as||"number"==typeof bs)return isNaN(as)?1:isNaN(bs)?-1:as-bs;if(a=(as+"").toLowerCase(),b=(bs+"").toLowerCase(),a===b)return 0;if(!rd.test(a)||!rd.test(b))return a>b?1:-1;for(a=a.match(rx),b=b.match(rx);a.length&&b.length;)if(a1=a.shift(),b1=b.shift(),a1!==b1)return rd.test(a1)&&rd.test(b1)?a1.replace(rz,".0")-b1.replace(rz,".0"):a1>b1?1:-1;return a.length-b.length},$.pivotUtilities={aggregatorTemplates:aggregatorTemplates,aggregators:aggregators,renderers:renderers,derivers:derivers,naturalSort:naturalSort,numberFormat:numberFormat},deriveAttributes=function(record,derivedAttributes,f){var k,v,_ref;for(k in derivedAttributes)v=derivedAttributes[k],record[k]=null!=(_ref=v(record))?_ref:record[k];for(k in record)__hasProp.call(record,k)&&null==record[k]&&(record[k]="null");return f(record)},forEachRecord=function(input,derivedAttributes,f){var addRecord,compactRecord,i,j,k,record,tblCols,_i,_len,_ref,_results,_results1;if(addRecord=function(record){return deriveAttributes(record,derivedAttributes,f)},$.isFunction(input))return input(addRecord);if($.isArray(input)){if($.isArray(input[0])){_results=[];for(i in input)if(__hasProp.call(input,i)&&(compactRecord=input[i],i>0)){record={},_ref=input[0];for(j in _ref)__hasProp.call(_ref,j)&&(k=_ref[j],record[k]=compactRecord[j]);_results.push(addRecord(record))}return _results}for(_results1=[],_i=0,_len=input.length;_len>_i;_i++)record=input[_i],_results1.push(addRecord(record));return _results1}if(input instanceof jQuery)return tblCols=[],$("thead > tr > th",input).each(function(i){return tblCols.push($(this).text())}),$("tbody > tr",input).each(function(i){return record={},$("td",this).each(function(j){return record[tblCols[j]]=$(this).text()}),addRecord(record)});throw Error("unknown input format")},convertToArray=function(input){var result;return result=[],forEachRecord(input,{},function(record){return result.push(record)}),result},PivotData=function(){function PivotData(aggregator,colAttrs,rowAttrs){this.aggregator=aggregator,this.colAttrs=colAttrs,this.rowAttrs=rowAttrs,this.getAggregator=__bind(this.getAggregator,this),this.flattenKey=__bind(this.flattenKey,this),this.getRowKeys=__bind(this.getRowKeys,this),this.getColKeys=__bind(this.getColKeys,this),this.sortKeys=__bind(this.sortKeys,this),this.arrSort=__bind(this.arrSort,this),this.natSort=__bind(this.natSort,this),this.tree={},this.rowKeys=[],this.colKeys=[],this.flatRowKeys=[],this.flatColKeys=[],this.rowTotals={},this.colTotals={},this.allTotal=this.aggregator(this,[],[]),this.sorted=!1}return PivotData.prototype.natSort=function(as,bs){return naturalSort(as,bs)},PivotData.prototype.arrSort=function(a,b){return this.natSort(a.join(),b.join())},PivotData.prototype.sortKeys=function(){return this.sorted||(this.rowKeys.sort(this.arrSort),this.colKeys.sort(this.arrSort)),this.sorted=!0},PivotData.prototype.getColKeys=function(){return this.sortKeys(),this.colKeys},PivotData.prototype.getRowKeys=function(){return this.sortKeys(),this.rowKeys},PivotData.prototype.flattenKey=function(x){return x.join(String.fromCharCode(0))},PivotData.prototype.processRecord=function(record){var colKey,flatColKey,flatRowKey,rowKey,x;return colKey=function(){var _i,_len,_ref,_results;for(_ref=this.colAttrs,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)x=_ref[_i],_results.push(record[x]);return _results}.call(this),rowKey=function(){var _i,_len,_ref,_results;for(_ref=this.rowAttrs,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)x=_ref[_i],_results.push(record[x]);return _results}.call(this),flatRowKey=this.flattenKey(rowKey),flatColKey=this.flattenKey(colKey),this.allTotal.push(record),0!==rowKey.length&&(0>__indexOf.call(this.flatRowKeys,flatRowKey)&&(this.rowKeys.push(rowKey),this.flatRowKeys.push(flatRowKey)),this.rowTotals[flatRowKey]||(this.rowTotals[flatRowKey]=this.aggregator(this,rowKey,[])),this.rowTotals[flatRowKey].push(record)),0!==colKey.length&&(0>__indexOf.call(this.flatColKeys,flatColKey)&&(this.colKeys.push(colKey),this.flatColKeys.push(flatColKey)),this.colTotals[flatColKey]||(this.colTotals[flatColKey]=this.aggregator(this,[],colKey)),this.colTotals[flatColKey].push(record)),0!==colKey.length&&0!==rowKey.length?(flatRowKey in this.tree||(this.tree[flatRowKey]={}),flatColKey in this.tree[flatRowKey]||(this.tree[flatRowKey][flatColKey]=this.aggregator(this,rowKey,colKey)),this.tree[flatRowKey][flatColKey].push(record)):void 0},PivotData.prototype.getAggregator=function(rowKey,colKey){var agg,flatColKey,flatRowKey;return flatRowKey=this.flattenKey(rowKey),flatColKey=this.flattenKey(colKey),agg=0===rowKey.length&&0===colKey.length?this.allTotal:0===rowKey.length?this.colTotals[flatColKey]:0===colKey.length?this.rowTotals[flatRowKey]:this.tree[flatRowKey][flatColKey],null!=agg?agg:{value:function(){return null},format:function(){return""}}},PivotData}(),getPivotData=function(input,cols,rows,aggregator,filter,derivedAttributes){var pivotData;return pivotData=new PivotData(aggregator,cols,rows),forEachRecord(input,derivedAttributes,function(record){return filter(record)?pivotData.processRecord(record):void 0}),pivotData},spanSize=function(arr,i,j){var len,noDraw,stop,x,_i,_j;if(0!==i){for(noDraw=!0,x=_i=0;j>=0?j>=_i:_i>=j;x=j>=0?++_i:--_i)arr[i-1][x]!==arr[i][x]&&(noDraw=!1);if(noDraw)return-1}for(len=0;arr.length>i+len;){for(stop=!1,x=_j=0;j>=0?j>=_j:_j>=j;x=j>=0?++_j:--_j)arr[i][x]!==arr[i+len][x]&&(stop=!0);if(stop)break;len++}return len},pivotTableRenderer=function(pivotData,opts){var aggregator,c,colAttrs,colKey,colKeys,defaults,i,j,r,result,rowAttrs,rowKey,rowKeys,th,totalAggregator,tr,txt,val,x;defaults={localeStrings:{totals:"Totals"}},opts=$.extend(defaults,opts),colAttrs=pivotData.colAttrs,rowAttrs=pivotData.rowAttrs,rowKeys=pivotData.getRowKeys(),colKeys=pivotData.getColKeys(),result=$("<table class='table table-bordered pvtTable'>");for(j in colAttrs)if(__hasProp.call(colAttrs,j)){c=colAttrs[j],tr=$("<tr>"),0===parseInt(j)&&0!==rowAttrs.length&&tr.append($("<th>").attr("colspan",rowAttrs.length).attr("rowspan",colAttrs.length)),tr.append($("<th class='pvtAxisLabel'>").text(c));for(i in colKeys)__hasProp.call(colKeys,i)&&(colKey=colKeys[i],x=spanSize(colKeys,parseInt(i),parseInt(j)),-1!==x&&(th=$("<th class='pvtColLabel'>").text(colKey[j]).attr("colspan",x),parseInt(j)===colAttrs.length-1&&0!==rowAttrs.length&&th.attr("rowspan",2),tr.append(th)));0===parseInt(j)&&tr.append($("<th class='pvtTotalLabel'>").text(opts.localeStrings.totals).attr("rowspan",colAttrs.length+(0===rowAttrs.length?0:1))),result.append(tr)}if(0!==rowAttrs.length){tr=$("<tr>");for(i in rowAttrs)__hasProp.call(rowAttrs,i)&&(r=rowAttrs[i],tr.append($("<th class='pvtAxisLabel'>").text(r)));th=$("<th>"),0===colAttrs.length&&th.addClass("pvtTotalLabel").text(opts.localeStrings.totals),tr.append(th),result.append(tr)}for(i in rowKeys)if(__hasProp.call(rowKeys,i)){rowKey=rowKeys[i],tr=$("<tr>");for(j in rowKey)__hasProp.call(rowKey,j)&&(txt=rowKey[j],x=spanSize(rowKeys,parseInt(i),parseInt(j)),-1!==x&&(th=$("<th class='pvtRowLabel'>").text(txt).attr("rowspan",x),parseInt(j)===rowAttrs.length-1&&0!==colAttrs.length&&th.attr("colspan",2),tr.append(th)));for(j in colKeys)__hasProp.call(colKeys,j)&&(colKey=colKeys[j],aggregator=pivotData.getAggregator(rowKey,colKey),val=aggregator.value(),tr.append($("<td class='pvtVal row"+i+" col"+j+"'>").html(aggregator.format(val)).data("value",val)));totalAggregator=pivotData.getAggregator(rowKey,[]),val=totalAggregator.value(),tr.append($("<td class='pvtTotal rowTotal'>").html(totalAggregator.format(val)).data("value",val).data("for","row"+i)),result.append(tr)}tr=$("<tr>"),th=$("<th class='pvtTotalLabel'>").text(opts.localeStrings.totals),th.attr("colspan",rowAttrs.length+(0===colAttrs.length?0:1)),tr.append(th);for(j in colKeys)__hasProp.call(colKeys,j)&&(colKey=colKeys[j],totalAggregator=pivotData.getAggregator([],colKey),val=totalAggregator.value(),tr.append($("<td class='pvtTotal colTotal'>").html(totalAggregator.format(val)).data("value",val).data("for","col"+j)));return totalAggregator=pivotData.getAggregator([],[]),val=totalAggregator.value(),tr.append($("<td class='pvtGrandTotal'>").html(totalAggregator.format(val)).data("value",val)),result.append(tr),result.data("dimensions",[rowKeys.length,colKeys.length]),result},$.fn.pivot=function(input,opts){var defaults,e,pivotData,result;defaults={cols:[],rows:[],filter:function(){return!0},aggregator:aggregators.count(),derivedAttributes:{},renderer:pivotTableRenderer,rendererOptions:null,localeStrings:{renderError:"An error occurred rendering the PivotTable results.",computeError:"An error occurred computing the PivotTable results."}},opts=$.extend(defaults,opts),result=null;try{pivotData=getPivotData(input,opts.cols,opts.rows,opts.aggregator,opts.filter,opts.derivedAttributes);try{result=opts.renderer(pivotData,opts.rendererOptions)}catch(_error){e=_error,"undefined"!=typeof console&&null!==console&&console.error(e.stack),result=opts.localeStrings.renderError}}catch(_error){e=_error,"undefined"!=typeof console&&null!==console&&console.error(e.stack),result=opts.localeStrings.computeError}return this.html(result),this},$.fn.pivotUI=function(input,inputOpts,overwrite){var aggregator,axisValues,c,colList,defaults,e,existingOpts,i,k,opts,pivotTable,refresh,refreshDelayed,renderer,rendererControl,shownAttributes,tblCols,tr1,tr2,uiTable,x,_fn,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_this=this;null==overwrite&&(overwrite=!1),defaults={derivedAttributes:{},aggregators:aggregators,renderers:renderers,hiddenAttributes:[],menuLimit:200,cols:[],rows:[],vals:[],exclusions:{},unusedAttrsVertical:!1,autoSortUnusedAttrs:!1,rendererOptions:null,onRefresh:null,filter:function(){return!0},localeStrings:{renderError:"An error occurred rendering the PivotTable results.",computeError:"An error occurred computing the PivotTable results.",uiRenderError:"An error occurred rendering the PivotTable UI.",selectAll:"Select All",selectNone:"Select None",tooMany:"(too many to list)"}},existingOpts=this.data("pivotUIOptions"),opts=null==existingOpts||overwrite?$.extend(defaults,inputOpts):existingOpts;try{input=convertToArray(input),tblCols=function(){var _ref,_results;_ref=input[0],_results=[];for(k in _ref)__hasProp.call(_ref,k)&&_results.push(k);return _results}(),_ref=opts.derivedAttributes;for(c in _ref)__hasProp.call(_ref,c)&&0>__indexOf.call(tblCols,c)&&tblCols.push(c);for(axisValues={},_i=0,_len=tblCols.length;_len>_i;_i++)x=tblCols[_i],axisValues[x]={};forEachRecord(input,opts.derivedAttributes,function(record){var v,_base,_results;_results=[];for(k in record)__hasProp.call(record,k)&&(v=record[k],null==v&&(v="null"),null==(_base=axisValues[k])[v]&&(_base[v]=0),_results.push(axisValues[k][v]++));return _results}),uiTable=$("<table class='table table-bordered' cellpadding='5'>"),rendererControl=$("<td>"),renderer=$("<select class='pvtRenderer'>").bind("change",function(){return refresh()}),_ref1=opts.renderers;for(x in _ref1)__hasProp.call(_ref1,x)&&renderer.append($("<option>").val(x).text(x));rendererControl.append(renderer),colList=$("<td class='pvtAxisContainer pvtUnused'>"),opts.unusedAttrsVertical?colList.addClass("pvtVertList"):colList.addClass("pvtHorizList"),shownAttributes=function(){var _j,_len1,_results;for(_results=[],_j=0,_len1=tblCols.length;_len1>_j;_j++)c=tblCols[_j],0>__indexOf.call(opts.hiddenAttributes,c)&&_results.push(c);return _results}(),_fn=function(c){var attrElem,btns,checkContainer,filterItem,filterItemExcluded,hasExcludedItem,keys,showFilterList,triangleLink,updateFilter,v,valueList,_j,_len1,_ref2;if(keys=function(){var _results;_results=[];for(k in axisValues[c])_results.push(k);return _results}(),hasExcludedItem=!1,valueList=$("<div>").addClass("pvtFilterBox").css({"z-index":100,width:"280px",border:"1px solid gray",background:"white",display:"none",position:"absolute",padding:"20px"}),valueList.append($("<div>").css({"text-align":"center","font-weight":"bold"}).text(""+c+" ("+keys.length+")")),keys.length>opts.menuLimit)valueList.append($("<p>").css({"text-align":"center"}).text(opts.localeStrings.tooMany));else{for(btns=$("<p>").css({"text-align":"center","margin-bottom":"5px"}),btns.append($("<button>").text(opts.localeStrings.selectAll).bind("click",function(){return valueList.find("input").prop("checked",!0)})),btns.append($("<button>").text(opts.localeStrings.selectNone).bind("click",function(){return valueList.find("input").prop("checked",!1)})),valueList.append(btns),checkContainer=$("<div>").css({overflow:"scroll",width:"280px","max-height":"200px"}),_ref2=keys.sort(naturalSort),_j=0,_len1=_ref2.length;_len1>_j;_j++)k=_ref2[_j],v=axisValues[c][k],filterItem=$("<label>"),filterItemExcluded=opts.exclusions[c]?__indexOf.call(opts.exclusions[c],k)>=0:!1,hasExcludedItem||(hasExcludedItem=filterItemExcluded),filterItem.append($("<input type='checkbox' class='pvtFilter'>").attr("checked",!filterItemExcluded).data("filter",[c,k])),filterItem.append($("<span>").text(""+k+" ("+v+")")),checkContainer.append($("<p>").css("margin","5px").append(filterItem));valueList.append(checkContainer)}return updateFilter=function(){var unselectedCount;return unselectedCount=$(valueList).find("[type='checkbox']").length-$(valueList).find("[type='checkbox']:checked").length,unselectedCount>0?attrElem.addClass("pvtFilteredAttribute"):attrElem.removeClass("pvtFilteredAttribute"),keys.length>opts.menuLimit?valueList.toggle():valueList.toggle(0,refresh)},valueList.append($("<p>").css({"text-align":"center","margin-bottom":0}).append($("<button>").text("OK").bind("click",updateFilter))),showFilterList=function(e){return valueList.css({left:e.pageX,top:e.pageY}).toggle()},triangleLink=$("<span class='pvtTriangle'>").html(" &#x25BE;").bind("click",showFilterList),attrElem=$("<li class='label label-info axis_"+i+"'>").append($("<nobr>").text(c).data("attrName",c).append(triangleLink)),hasExcludedItem&&attrElem.addClass("pvtFilteredAttribute"),colList.append(attrElem).append(valueList),attrElem.bind("dblclick",showFilterList)};for(i in shownAttributes)c=shownAttributes[i],_fn(c);tr1=$("<tr>"),aggregator=$("<select class='pvtAggregator'>").css("margin-bottom","5px").bind("change",function(){return refresh()}),_ref2=opts.aggregators;for(x in _ref2)__hasProp.call(_ref2,x)&&aggregator.append($("<option>").val(x).text(x));for(tr1.append($("<td class='pvtAxisContainer pvtHorizList pvtVals'>").css("text-align","center").append(aggregator).append($("<br>"))),tr1.append($("<td class='pvtAxisContainer pvtHorizList pvtCols'>")),uiTable.append(tr1),tr2=$("<tr>"),tr2.append($("<td valign='top' class='pvtAxisContainer pvtRows'>")),pivotTable=$("<td valign='top' class='pvtRendererArea'>"),tr2.append(pivotTable),uiTable.append(tr2),opts.unusedAttrsVertical?(uiTable.find("tr:nth-child(1)").prepend(rendererControl),uiTable.find("tr:nth-child(2)").prepend(colList.css("vertical-align","top"))):uiTable.prepend($("<tr>").append(rendererControl).append(colList)),this.html(uiTable),_ref3=opts.cols,_j=0,_len1=_ref3.length;_len1>_j;_j++)x=_ref3[_j],this.find(".pvtCols").append(this.find(".axis_"+shownAttributes.indexOf(x)));for(_ref4=opts.rows,_k=0,_len2=_ref4.length;_len2>_k;_k++)x=_ref4[_k],this.find(".pvtRows").append(this.find(".axis_"+shownAttributes.indexOf(x)));for(_ref5=opts.vals,_l=0,_len3=_ref5.length;_len3>_l;_l++)x=_ref5[_l],this.find(".pvtVals").append(this.find(".axis_"+shownAttributes.indexOf(x)));null!=opts.aggregatorName&&this.find(".pvtAggregator").val(opts.aggregatorName),null!=opts.rendererName&&this.find(".pvtRenderer").val(opts.rendererName),refreshDelayed=function(){var exclusions,natSort,subopts,unusedAttrsContainer,vals;return subopts={derivedAttributes:opts.derivedAttributes,localeStrings:opts.localeStrings,rendererOptions:opts.rendererOptions,cols:[],rows:[]},vals=[],_this.find(".pvtRows li nobr").each(function(){return subopts.rows.push($(this).data("attrName"))}),_this.find(".pvtCols li nobr").each(function(){return subopts.cols.push($(this).data("attrName"))}),_this.find(".pvtVals li nobr").each(function(){return vals.push($(this).data("attrName"))}),subopts.aggregator=opts.aggregators[aggregator.val()](vals),subopts.renderer=opts.renderers[renderer.val()],exclusions={},_this.find("input.pvtFilter").not(":checked").each(function(){var filter;return filter=$(this).data("filter"),console.log(filter),null!=exclusions[filter[0]]?exclusions[filter[0]].push(filter[1]):exclusions[filter[0]]=[filter[1]]}),subopts.filter=function(record){var excludedItems,_ref6;if(!opts.filter(record))return!1;for(k in exclusions)if(excludedItems=exclusions[k],_ref6=""+record[k],__indexOf.call(excludedItems,_ref6)>=0)return!1;return!0},pivotTable.pivot(input,subopts),_this.data("pivotUIOptions",{cols:subopts.cols,rows:subopts.rows,vals:vals,exclusions:exclusions,hiddenAttributes:opts.hiddenAttributes,renderers:opts.renderers,aggregators:opts.aggregators,filter:opts.filter,derivedAttributes:opts.derivedAttributes,aggregatorName:aggregator.val(),rendererName:renderer.val(),localeStrings:opts.localeStrings,rendererOptions:opts.rendererOptions}),opts.autoSortUnusedAttrs&&(natSort=$.pivotUtilities.naturalSort,unusedAttrsContainer=_this.find("td.pvtUnused.pvtAxisContainer"),$(unusedAttrsContainer).children("li").sort(function(a,b){return natSort($(a).text(),$(b).text())}).appendTo(unusedAttrsContainer)),pivotTable.css("opacity",1),null!=opts.onRefresh?opts.onRefresh():void 0},refresh=function(){return pivotTable.css("opacity",.5),setTimeout(refreshDelayed,10)},refresh(),this.find(".pvtAxisContainer").sortable({update:refresh,connectWith:this.find(".pvtAxisContainer"),items:"li",placeholder:"placeholder"})}catch(_error){e=_error,"undefined"!=typeof console&&null!==console&&console.error(e.stack),this.html(opts.localeStrings.uiRenderError)}return this},$.fn.heatmap=function(scope){var colorGen,heatmapper,i,j,numCols,numRows,_i,_j,_ref,_this=this;switch(null==scope&&(scope="heatmap"),_ref=this.data("dimensions"),numRows=_ref[0],numCols=_ref[1],colorGen=function(color,min,max){var hexGen;return hexGen=function(){switch(color){case"red":return function(hex){return"ff"+hex+hex};case"green":return function(hex){return""+hex+"ff"+hex};case"blue":return function(hex){return""+hex+hex+"ff"}}}(),function(x){var hex,intensity;return intensity=255-Math.round(255*(x-min)/(max-min)),hex=intensity.toString(16).split(".")[0],1===hex.length&&(hex=0+hex),hexGen(hex)}},heatmapper=function(scope,color){var colorFor,forEachCell,values;return forEachCell=function(f){return _this.find(scope).each(function(){var x;return x=$(this).data("value"),null!=x&&isFinite(x)?f(x,$(this)):void 0})},values=[],forEachCell(function(x){return values.push(x)}),colorFor=colorGen(color,Math.min.apply(Math,values),Math.max.apply(Math,values)),forEachCell(function(x,elem){return elem.css("background-color","#"+colorFor(x))})},scope){case"heatmap":heatmapper(".pvtVal","red");break;case"rowheatmap":for(i=_i=0;numRows>=0?numRows>_i:_i>numRows;i=numRows>=0?++_i:--_i)heatmapper(".pvtVal.row"+i,"red");break;case"colheatmap":for(j=_j=0;numCols>=0?numCols>_j:_j>numCols;j=numCols>=0?++_j:--_j)heatmapper(".pvtVal.col"+j,"red")}return heatmapper(".pvtTotal.rowTotal","red"),heatmapper(".pvtTotal.colTotal","red"),this},$.fn.barchart=function(){var barcharter,i,numCols,numRows,_i,_ref,_this=this;for(_ref=this.data("dimensions"),numRows=_ref[0],numCols=_ref[1],barcharter=function(scope){var forEachCell,max,scaler,values;return forEachCell=function(f){return _this.find(scope).each(function(){var x;return x=$(this).data("value"),null!=x&&isFinite(x)?f(x,$(this)):void 0})},values=[],forEachCell(function(x){return values.push(x)}),max=Math.max.apply(Math,values),scaler=function(x){return 100*x/(1.4*max)},forEachCell(function(x,elem){var text,wrapper;return text=elem.text(),wrapper=$("<div>").css({position:"relative",height:"55px"}),wrapper.append($("<div>").css({position:"absolute",bottom:0,left:0,right:0,height:scaler(x)+"%","background-color":"gray"})),wrapper.append($("<div>").text(text).css({position:"relative","padding-left":"5px","padding-right":"5px"})),elem.css({padding:0,"padding-top":"5px","text-align":"center"}).html(wrapper)})},i=_i=0;numRows>=0?numRows>_i:_i>numRows;i=numRows>=0?++_i:--_i)barcharter(".pvtVal.row"+i);return barcharter(".pvtTotal.colTotal"),this}}).call(this);

            Rally.launchApp('CustomApp', {
                name:"cycletimebystate",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
    <style type="text/css">
        
table.pvtTable {
    font-family:arial;
    font-size: 8pt;
    text-align: left;
    border-collapse: collapse;
}
table.pvtTable tr th, table.pvtTable tr th {
    background-color: #e6EEEE;
    border: 1px solid #CDCDCD;
    font-size: 8pt;
    padding: 5px;
}

table.pvtTable .pvtColLabel {text-align: center;}
table.pvtTable .pvtTotalLabel {text-align: right;}

table.pvtTable tr td {
    color: #3D3D3D;
    padding: 5px;
    background-color: #FFF;
    border: 1px solid #CDCDCD;
    vertical-align: top;
    text-align: right;
}

.pvtTotal, .pvtGrandTotal { font-weight: bold; }

.pvtAxisContainer {
    border: 1px solid gray;
    background: #EEE;
    padding: 5px;
    min-width: 20px;
    min-height: 20px;
}
.pvtAxisContainer li {
    padding: 8px 6px;
    list-style-type: none;
    cursor:move;
}
.pvtAxisContainer li.placeholder {
    -webkit-border-radius: 5px;
    padding: 3px 15px;
    -moz-border-radius: 5px;
    border-radius: 5px;
    border: 1px dashed #aaa;
}

.pvtAxisContainer li nobr {
    background: #F3F3F3;
    border: 1px solid #DEDEDE;
    padding: 2px 5px;
    
    -webkit-border-radius: 5px;
    -moz-border-radius: 5px;
    border-radius: 5px;
}

.pvtTriangle {
    cursor:pointer;
    color: grey;
}

.pvtHorizList li { display: inline; }

.pvtFilteredAttribute { font-style: italic }

    </style>
</head>
<body></body>
</html>
